// ============================================================================
// MONETIZATION & WALLET SCHEMA ADDITIONS
// Add these models to your existing Prisma schema
// ============================================================================

enum TransactionType {
  tip_sent
  tip_received
  purchase
  payout
  paywall_unlock
  gig_payment
  gig_escrow
  gig_release
  platform_fee
  refund
  adjustment
}

enum TransactionStatus {
  pending
  processing
  completed
  failed
  refunded
  cancelled
}

enum PayoutStatus {
  pending
  approved
  processing
  paid
  failed
  rejected
}

enum KycStatus {
  none
  pending
  verified
  failed
  requires_action
}

enum StripeAccountStatus {
  pending
  active
  restricted
  disabled
}

enum LedgerEntryType {
  debit
  credit
}

// ============================================================================
// WALLET MODEL
// ============================================================================

model Wallet {
  id              String               @id @default(uuid())
  userId          String               @unique
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Balance tracking
  balance         Int                  @default(0) // Available balance in cents
  pendingBalance  Int                  @default(0) // Funds in escrow/pending
  lifetimeEarned  Int                  @default(0)
  lifetimeSpent   Int                  @default(0)
  
  // Stripe Connect
  stripeAccountId       String?        @unique
  stripeAccountStatus   StripeAccountStatus @default(pending)
  kycStatus             KycStatus      @default(none)
  canReceivePayments    Boolean        @default(false)
  canRequestPayouts     Boolean        @default(false)
  
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  
  // Relations
  transactions    Transaction[]
  ledgerEntries   LedgerEntry[]
  payouts         Payout[]
  tipsSent        Tip[]                @relation("TipSender")
  tipsReceived    Tip[]                @relation("TipReceiver")
  
  @@index([userId])
  @@index([stripeAccountId])
  @@index([stripeAccountStatus])
}

// ============================================================================
// TRANSACTION MODEL (High-level transaction records)
// ============================================================================

model Transaction {
  id                    String            @id @default(uuid())
  walletId              String
  wallet                Wallet            @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  // Transaction details
  type                  TransactionType
  amount                Int               // In cents (positive or negative)
  fee                   Int               @default(0) // Platform fee
  netAmount             Int               // Amount after fee
  status                TransactionStatus @default(pending)
  description           String
  
  // Related entities
  relatedUserId         String?
  relatedUser           User?             @relation("TransactionRelatedUser", fields: [relatedUserId], references: [id], onDelete: SetNull)
  relatedPostId         String?
  relatedPost           Post?             @relation(fields: [relatedPostId], references: [id], onDelete: SetNull)
  relatedGigId          String?
  relatedPayout         Payout?           @relation("PayoutTransaction")
  
  // Stripe references
  stripePaymentIntentId String?           @unique
  stripeTransferId      String?           @unique
  
  // Metadata
  metadata              Json?
  
  createdAt             DateTime          @default(now())
  completedAt           DateTime?
  
  // Relations
  ledgerEntries         LedgerEntry[]
  tip                   Tip?              @relation("TipTransaction")
  
  @@index([walletId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([relatedUserId])
  @@index([relatedPostId])
  @@index([relatedGigId])
}

// ============================================================================
// LEDGER ENTRY MODEL (Double-entry bookkeeping)
// ============================================================================

model LedgerEntry {
  id              String           @id @default(uuid())
  transactionId   String
  transaction     Transaction      @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  walletId        String
  wallet          Wallet           @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  entryType       LedgerEntryType  // debit or credit
  amount          Int              // Always positive
  balance         Int              // Wallet balance after this entry
  description     String
  
  createdAt       DateTime         @default(now())
  
  @@index([transactionId])
  @@index([walletId])
  @@index([createdAt])
}

// ============================================================================
// TIP MODEL
// ============================================================================

model Tip {
  id              String            @id @default(uuid())
  
  // Participants
  senderId        String
  sender          Wallet            @relation("TipSender", fields: [senderId], references: [userId], onDelete: Cascade)
  receiverId      String
  receiver        Wallet            @relation("TipReceiver", fields: [receiverId], references: [userId], onDelete: Cascade)
  
  // Tip details
  amount          Int               // In cents
  fee             Int               // Platform fee
  netAmount       Int               // Amount received by creator
  message         String?
  isAnonymous     Boolean           @default(false)
  
  // Related content
  postId          String?
  post            Post?             @relation(fields: [postId], references: [id], onDelete: SetNull)
  
  // Transaction reference
  transactionId   String            @unique
  transaction     Transaction       @relation("TipTransaction", fields: [transactionId], references: [id], onDelete: Cascade)
  
  status          TransactionStatus @default(completed)
  createdAt       DateTime          @default(now())
  
  @@index([senderId])
  @@index([receiverId])
  @@index([postId])
  @@index([createdAt])
}

// ============================================================================
// PAYOUT MODEL
// ============================================================================

model Payout {
  id                  String         @id @default(uuid())
  userId              String
  user                User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  walletId            String
  wallet              Wallet         @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  // Payout details
  amount              Int            // Amount in cents
  fee                 Int            // Transfer fee
  netAmount           Int            // Amount sent to bank
  status              PayoutStatus   @default(pending)
  
  // Stripe references
  stripeTransferId    String?        @unique
  stripePayoutId      String?        @unique
  bankAccountLast4    String?
  
  // Approval workflow
  requestedAt         DateTime       @default(now())
  approvedAt          DateTime?
  approvedBy          String?        // Admin user ID
  approver            User?          @relation("PayoutApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  paidAt              DateTime?
  rejectedAt          DateTime?
  rejectionReason     String?
  notes               String?
  
  // Transaction reference
  transactionId       String         @unique
  transaction         Transaction    @relation("PayoutTransaction", fields: [transactionId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([walletId])
  @@index([status])
  @@index([requestedAt])
  @@index([paidAt])
}

// ============================================================================
// USER MODEL ADDITIONS
// Add these relations to your existing User model
// ============================================================================

model User {
  // ... existing fields ...
  
  // Wallet relations
  wallet              Wallet?
  transactionsFrom    Transaction[]  @relation("TransactionRelatedUser")
  payouts             Payout[]
  payoutApprovals     Payout[]       @relation("PayoutApprover")
  
  // ... rest of existing relations ...
}

// ============================================================================
// POST MODEL ADDITIONS
// Add these relations to your existing Post model
// ============================================================================

model Post {
  // ... existing fields ...
  
  // Monetization relations
  transactions        Transaction[]
  tips                Tip[]
  
  // ... rest of existing relations ...
}
