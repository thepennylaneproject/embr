// Embr Platform Database Schema
// Complete schema for social media + freelance marketplace

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // For migrations
}

// ============================================
// USER & AUTHENTICATION
// ============================================

enum UserRole {
  user
  creator
  admin
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String?   // Nullable for OAuth-only users
  role          UserRole  @default(user)
  isVerified    Boolean   @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // Soft delete

  // Relations
  profile       Profile?
  posts         Post[]
  comments      Comment[]
  likes         Like[]
  followers     Follow[]  @relation("Following")
  following     Follow[]  @relation("Follower")
  tips          Tip[]     @relation("TipSender")
  tipsReceived  Tip[]     @relation("TipReceiver")
  wallet        Wallet?
  gigs          Gig[]
  bookings      Booking[] @relation("BookingBuyer")
  bookingsAsCreator Booking[] @relation("BookingCreator")
  applications  Application[]
  reviews       Review[]  @relation("Reviewer")
  reviewsReceived Review[] @relation("Reviewee")
  conversations1 Conversation[] @relation("Participant1")
  conversations2 Conversation[] @relation("Participant2")
  messages      Message[]
  notifications Notification[]
  reports       Report[]  @relation("Reporter")
  reportsReceived Report[] @relation("ReportedUser")
  moderationActions ModerationAction[] @relation("AffectedUser")
  moderatorActions ModerationAction[] @relation("Moderator")
  appeals       Appeal[]
  analyticsEvents AnalyticsEvent[]

  @@index([email])
  @@index([role])
  @@index([deletedAt])
}

model Profile {
  id             String   @id @default(uuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  username       String   @unique
  displayName    String
  bio            String?
  avatarUrl      String?
  bannerUrl      String?
  location       String?
  website        String?
  socialLinks    Json?    // { twitter, instagram, linkedin, etc }
  skills         String[] // For creators
  categories     String[] // Content categories
  followerCount  Int      @default(0)
  followingCount Int      @default(0)
  postCount      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([username])
  @@index([userId])
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String
  follower    User     @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  followingId String
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// ============================================
// CONTENT & SOCIAL
// ============================================

enum PostType {
  text
  image
  video
}

enum PostVisibility {
  public
  followers
  private
}

model Post {
  id            String         @id @default(uuid())
  authorId      String
  author        User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  type          PostType       @default(text)
  content       String?
  mediaUrl      String?
  thumbnailUrl  String?
  muxAssetId    String?        // For video processing
  muxPlaybackId String?
  visibility    PostVisibility @default(public)
  hashtags      String[]
  mentions      String[]       // User IDs
  viewCount     Int            @default(0)
  likeCount     Int            @default(0)
  commentCount  Int            @default(0)
  shareCount    Int            @default(0)
  duration      Int?           // Video duration in seconds
  isProcessing  Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?      // Soft delete

  // Relations
  comments      Comment[]
  likes         Like[]
  reports       Report[]

  @@index([authorId])
  @@index([type])
  @@index([visibility])
  @@index([createdAt])
  @@index([deletedAt])
}

model Comment {
  id        String    @id @default(uuid())
  postId    String
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId  String
  author    User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content   String
  parentId  String?   // For nested replies
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
  likeCount Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  reports   Report[]

  @@index([postId])
  @@index([authorId])
  @@index([parentId])
  @@index([createdAt])
}

model Like {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
}

// ============================================
// MONETIZATION & WALLET
// ============================================

enum TransactionType {
  tip
  gig_payment
  payout
  refund
  platform_fee
}

enum TransactionStatus {
  pending
  completed
  failed
  refunded
}

model Wallet {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance         Int      @default(0) // In cents
  pendingBalance  Int      @default(0) // Escrowed funds
  totalEarned     Int      @default(0)
  totalWithdrawn  Int      @default(0)
  stripeAccountId String?  // For payouts
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  transactions    Transaction[]

  @@index([userId])
}

model Transaction {
  id                  String            @id @default(uuid())
  walletId            String
  wallet              Wallet            @relation(fields: [walletId], references: [id], onDelete: Cascade)
  type                TransactionType
  amount              Int               // In cents
  fee                 Int               @default(0) // Platform fee
  status              TransactionStatus @default(pending)
  stripePaymentId     String?
  stripeTransferId    String?
  description         String?
  relatedBookingId    String?
  relatedTipId        String?
  metadata            Json?
  createdAt           DateTime          @default(now())
  completedAt         DateTime?

  @@index([walletId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model Tip {
  id         String   @id @default(uuid())
  senderId   String
  sender     User     @relation("TipSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId String
  receiver   User     @relation("TipReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  postId     String?  // Optional: tip for specific post
  amount     Int      // In cents
  message    String?
  isAnonymous Boolean @default(false)
  createdAt  DateTime @default(now())

  @@index([senderId])
  @@index([receiverId])
  @@index([postId])
  @@index([createdAt])
}

// ============================================
// GIGS & MARKETPLACE
// ============================================

enum GigCategory {
  video_editing
  graphic_design
  social_media
  content_writing
  voiceover
  music
  animation
  photography
  consulting
  other
}

enum GigStatus {
  draft
  active
  paused
  closed
}

model Gig {
  id            String      @id @default(uuid())
  creatorId     String
  creator       User        @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  title         String
  description   String
  category      GigCategory
  startingPrice Int         // In cents
  deliveryDays  Int
  portfolioUrls String[]
  skills        String[]
  status        GigStatus   @default(draft)
  viewCount     Int         @default(0)
  orderCount    Int         @default(0)
  rating        Float?
  reviewCount   Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  deletedAt     DateTime?   // Soft delete

  // Relations
  bookings      Booking[]

  @@index([creatorId])
  @@index([category])
  @@index([status])
  @@index([createdAt])
}

enum BookingStatus {
  pending
  accepted
  in_progress
  revision_requested
  completed
  cancelled
  disputed
}

model Booking {
  id          String        @id @default(uuid())
  gigId       String
  gig         Gig           @relation(fields: [gigId], references: [id], onDelete: Cascade)
  buyerId     String
  buyer       User          @relation("BookingBuyer", fields: [buyerId], references: [id], onDelete: Cascade)
  creatorId   String
  creator     User          @relation("BookingCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  scope       String        // Detailed requirements
  agreedPrice Int           // In cents
  platformFee Int           // Platform commission
  status      BookingStatus @default(pending)
  deliverables String[]     // URLs to completed work
  feedback    String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  completedAt DateTime?
  cancelledAt DateTime?

  // Relations
  escrow      Escrow?
  review      Review?

  @@index([gigId])
  @@index([buyerId])
  @@index([creatorId])
  @@index([status])
}

enum EscrowStatus {
  held
  released
  refunded
}

model Escrow {
  id                    String       @id @default(uuid())
  bookingId             String       @unique
  booking               Booking      @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  amount                Int          // In cents
  status                EscrowStatus @default(held)
  stripePaymentIntentId String
  releasedAt            DateTime?
  createdAt             DateTime     @default(now())

  @@index([status])
}

model Review {
  id         String   @id @default(uuid())
  bookingId  String   @unique
  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  reviewerId String
  reviewer   User     @relation("Reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
  revieweeId String
  reviewee   User     @relation("Reviewee", fields: [revieweeId], references: [id], onDelete: Cascade)
  rating     Int      // 1-5 stars
  comment    String?
  response   String?  // Reviewee's response
  createdAt  DateTime @default(now())

  @@index([revieweeId])
}

// ============================================
// JOBS BOARD (Relevnt Integration)
// ============================================

enum JobStatus {
  active
  filled
  expired
}

model Job {
  id           String      @id @default(uuid())
  relevntId    String      @unique
  title        String
  company      String
  location     String
  salaryMin    Int?
  salaryMax    Int?
  remote       Boolean     @default(false)
  description  String      @db.Text
  requirements String[]
  benefits     String[]
  applyUrl     String
  tags         String[]
  postedAt     DateTime
  expiresAt    DateTime?
  lastSyncedAt DateTime    @default(now())
  status       JobStatus   @default(active)

  // Relations
  applications Application[]

  @@index([relevntId])
  @@index([status])
  @@index([remote])
  @@index([postedAt])
}

enum ApplicationStatus {
  submitted
  viewed
  interviewing
  rejected
  accepted
  withdrawn
}

model Application {
  id             String            @id @default(uuid())
  jobId          String
  job            Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)
  userId         String
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  resumeUrl      String
  portfolioUrls  String[]
  coverLetter    String?           @db.Text
  status         ApplicationStatus @default(submitted)
  submittedAt    DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@unique([jobId, userId])
  @@index([jobId])
  @@index([userId])
  @@index([status])
}

// ============================================
// MESSAGING
// ============================================

model Conversation {
  id             String   @id @default(uuid())
  participant1Id String
  participant1   User     @relation("Participant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2Id String
  participant2   User     @relation("Participant2", fields: [participant2Id], references: [id], onDelete: Cascade)
  lastMessageAt  DateTime @default(now())
  createdAt      DateTime @default(now())

  // Relations
  messages       Message[]

  @@unique([participant1Id, participant2Id])
  @@index([participant1Id])
  @@index([participant2Id])
  @@index([lastMessageAt])
}

enum MessageType {
  text
  image
  video
  audio
  gig_offer
}

enum MessageStatus {
  sent
  delivered
  read
}

model Message {
  id             String        @id @default(uuid())
  conversationId String
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User          @relation(fields: [senderId], references: [id], onDelete: Cascade)
  content        String?       @db.Text
  mediaUrl       String?
  type           MessageType   @default(text)
  status         MessageStatus @default(sent)
  createdAt      DateTime      @default(now())
  readAt         DateTime?

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

// ============================================
// NOTIFICATIONS
// ============================================

enum NotificationType {
  like
  comment
  follow
  tip
  message
  gig_booking
  gig_completed
  job_update
  system
}

model Notification {
  id            String           @id @default(uuid())
  userId        String
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          NotificationType
  title         String
  body          String
  actionUrl     String?
  relatedUserId String?
  relatedPostId String?
  isRead        Boolean          @default(false)
  createdAt     DateTime         @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ============================================
// CONTENT MODERATION
// ============================================

enum ReportReason {
  spam
  harassment
  illegal
  nsfw_unlabeled
  copyright
  impersonation
  self_harm
  other
}

enum ReportStatus {
  pending
  under_review
  action_taken
  dismissed
}

model Report {
  id                String       @id @default(uuid())
  reporterId        String
  reporter          User         @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUserId    String?
  reportedUser      User?        @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: Cascade)
  reportedPostId    String?
  reportedPost      Post?        @relation(fields: [reportedPostId], references: [id], onDelete: Cascade)
  reportedCommentId String?
  reportedComment   Comment?     @relation(fields: [reportedCommentId], references: [id], onDelete: Cascade)
  reason            ReportReason
  description       String?      @db.Text
  status            ReportStatus @default(pending)
  reviewerId        String?
  reviewedAt        DateTime?
  action            String?
  createdAt         DateTime     @default(now())

  @@index([status])
  @@index([reportedUserId])
  @@index([createdAt])
}

enum ActionType {
  warning
  content_removal
  suspension
  ban
}

model ModerationAction {
  id          String     @id @default(uuid())
  userId      String
  user        User       @relation("AffectedUser", fields: [userId], references: [id], onDelete: Cascade)
  moderatorId String
  moderator   User       @relation("Moderator", fields: [moderatorId], references: [id], onDelete: Cascade)
  type        ActionType
  reason      String     @db.Text
  duration    Int?       // Duration in days (null = permanent)
  postId      String?
  commentId   String?
  appealable  Boolean    @default(true)
  createdAt   DateTime   @default(now())
  expiresAt   DateTime?

  // Relations
  appeals     Appeal[]

  @@index([userId])
  @@index([type])
  @@index([expiresAt])
}

enum AppealStatus {
  pending
  under_review
  approved
  denied
}

model Appeal {
  id         String              @id @default(uuid())
  actionId   String
  action     ModerationAction    @relation(fields: [actionId], references: [id], onDelete: Cascade)
  userId     String
  user       User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  reason     String              @db.Text
  status     AppealStatus        @default(pending)
  reviewerId String?
  reviewNote String?             @db.Text
  createdAt  DateTime            @default(now())
  resolvedAt DateTime?

  @@index([actionId])
  @@index([status])
}

// ============================================
// ANALYTICS
// ============================================

enum AnalyticsEventType {
  view
  like
  comment
  share
  tip
  profile_view
  follow
  video_watch
  gig_view
  job_view
}

model AnalyticsEvent {
  id           String             @id @default(uuid())
  userId       String?
  user         User?              @relation(fields: [userId], references: [id], onDelete: SetNull)
  type         AnalyticsEventType
  entityType   String             // 'post', 'gig', 'job', 'user'
  entityId     String
  metadata     Json?              // Additional event data
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime           @default(now())

  @@index([userId])
  @@index([type])
  @@index([entityType, entityId])
  @@index([createdAt])
}
